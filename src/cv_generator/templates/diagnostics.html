{% extends "base.html" %}

{% block title %}Diagnostics{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &rsaquo; Diagnostics
</div>

<h2>ğŸ” Diagnostics Panel</h2>

<div class="card-grid">
    <!-- Database Health -->
    <div class="card">
        <h3>Database Health</h3>
        <div class="health-check-item">
            <span>Status:</span>
            {% if health.healthy %}
                <span class="status-ok">âœ“ Healthy</span>
            {% else %}
                <span class="status-error">âœ— Issues Found</span>
            {% endif %}
        </div>
        <div class="health-check-item">
            <span>Persons:</span>
            <span>{{ health.stats.persons }}</span>
        </div>
        <div class="health-check-item">
            <span>Entries:</span>
            <span>{{ health.stats.entries }}</span>
        </div>
        <div class="health-check-item">
            <span>Tags:</span>
            <span>{{ health.stats.tags }}</span>
        </div>
        <div class="health-check-item">
            <span>Tag Assignments:</span>
            <span>{{ health.stats.tag_assignments }}</span>
        </div>
        {% if health.stats.stable_entries is defined %}
        <div class="health-check-item">
            <span>Stable Entries:</span>
            <span>{{ health.stats.stable_entries }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Issues -->
    <div class="card">
        <h3>Issues ({{ health.issues|length }})</h3>
        {% if health.issues %}
            <ul class="issue-list">
                {% for issue in health.issues %}
                    <li class="status-warning">{{ issue }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="status-ok">No issues detected.</p>
        {% endif %}
    </div>
</div>

<!-- Reference Integrity -->
{% if integrity %}
<div class="card" style="margin-top: 1rem;">
    <h3>ğŸ”— Reference Integrity</h3>
    <div class="health-check-item">
        <span>Status:</span>
        {% if integrity.is_healthy %}
            <span class="status-ok">âœ“ All references valid</span>
        {% else %}
            <span class="status-error">âœ— Issues Found ({{ integrity.error_count }} errors, {{ integrity.warning_count }} warnings)</span>
        {% endif %}
    </div>
    {% if integrity.stats %}
    <div style="margin-top: 0.5rem;">
        {% if integrity.stats.stable_entries is defined %}
        <div class="health-check-item">
            <span>Stable Entries:</span>
            <span>{{ integrity.stats.stable_entries }}</span>
        </div>
        {% endif %}
        {% if integrity.stats.entry_lang_links is defined %}
        <div class="health-check-item">
            <span>Entry-Language Links:</span>
            <span>{{ integrity.stats.entry_lang_links }}</span>
        </div>
        {% endif %}
        {% if integrity.stats.person_entities is defined %}
        <div class="health-check-item">
            <span>Person Entities:</span>
            <span>{{ integrity.stats.person_entities }}</span>
        </div>
        {% endif %}
        {% if integrity.stats.entries_without_stable_ids is defined and integrity.stats.entries_without_stable_ids > 0 %}
        <div class="health-check-item">
            <span>Entries Without Stable IDs:</span>
            <span class="status-warning">{{ integrity.stats.entries_without_stable_ids }}</span>
        </div>
        {% endif %}
    </div>
    {% endif %}
    {% if integrity.issues %}
    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; color: var(--primary);">Show {{ integrity.issues|length }} issue(s)</summary>
        <ul class="issue-list" style="margin-top: 0.5rem;">
            {% for issue in integrity.issues[:20] %}
                <li class="{% if issue.severity.value == 'error' %}status-error{% elif issue.severity.value == 'warning' %}status-warning{% else %}status-ok{% endif %}">
                    <strong>[{{ issue.category }}]</strong> {{ issue.message }}
                </li>
            {% endfor %}
            {% if integrity.issues|length > 20 %}
                <li>... and {{ integrity.issues|length - 20 }} more issues</li>
            {% endif %}
        </ul>
    </details>
    {% endif %}
</div>
{% endif %}

<!-- Orphan Tags Section -->
{% if health.checks.orphaned_tags and health.checks.orphaned_tags.count > 0 %}
<div class="card" style="margin-top: 1rem;">
    <h3>ğŸ·ï¸ Unused Tags ({{ health.checks.orphaned_tags.count }})</h3>
    <p>These tags are not assigned to any entries:</p>
    <div style="margin: 1rem 0;">
        {% for tag_name in health.checks.orphaned_tags.names %}
            <span class="tag tag-count">{{ tag_name }}</span>
        {% endfor %}
        {% if health.checks.orphaned_tags.count > health.checks.orphaned_tags.names|length %}
            <span>... and {{ health.checks.orphaned_tags.count - health.checks.orphaned_tags.names|length }} more</span>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Missing Tag Translations -->
{% if missing_translations %}
<div class="card" style="margin-top: 1rem;">
    <h3>ğŸŒ Missing Tag Translations ({{ current_language|upper }})</h3>
    <p>These tags don't have translations for the current display language:</p>
    <div style="margin: 1rem 0;">
        {% for tag_id in missing_translations %}
            <span class="tag tag-count">{{ tag_id }}</span>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Entries Needing Translation -->
{% if entries_needing_translation %}
<div class="card" style="margin-top: 1rem;">
    <h3>ğŸ“ Entries Needing Translation ({{ entries_needing_translation|length }})</h3>
    <p>These entries were auto-created and need translation:</p>
    <div class="list-item-container">
        {% for entry in entries_needing_translation[:10] %}
            <div class="list-item">
                <a href="{{ url_for('entry_detail', entry_id=entry.id) }}">
                    <strong>{{ entry.section }}</strong> - {{ entry.summary }}
                    <span class="entry-meta">{{ entry.person_slug }} ({{ entry.language|upper }})</span>
                </a>
            </div>
        {% endfor %}
        {% if entries_needing_translation|length > 10 %}
            <p class="entry-meta">... and {{ entries_needing_translation|length - 10 }} more</p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Missing Language Counterparts -->
{% if missing_counterparts %}
<div class="card" style="margin-top: 1rem;">
    <h3>ğŸ”— Entries Missing Language Variants ({{ missing_counterparts|length }})</h3>
    <p>These entries don't have counterparts in all supported languages:</p>
    <div class="list-item-container">
        {% for entry in missing_counterparts[:10] %}
            <div class="list-item">
                <div>
                    <strong>{{ entry.section }}</strong> ({{ entry.base_person }})
                    <span class="entry-meta">
                        Has: {{ entry.existing_languages|join(', ')|upper }}
                        | Missing: <span class="status-warning">{{ entry.missing_languages|join(', ')|upper }}</span>
                    </span>
                </div>
            </div>
        {% endfor %}
        {% if missing_counterparts|length > 10 %}
            <p class="entry-meta">... and {{ missing_counterparts|length - 10 }} more</p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Actions -->
<div class="card" style="margin-top: 1rem;">
    <h3>ğŸ› ï¸ Actions</h3>
    <form id="cleanup-form" action="{{ url_for('cleanup_orphans') }}" method="post" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="button" class="btn btn-secondary"
                onclick="return confirmAction('cleanup-form', 'This will remove orphan tag references from entries. Continue?')">
            Clean Up Orphan Tag References
        </button>
    </form>
</div>

{% if not health.issues and not missing_translations and not entries_needing_translation and not missing_counterparts %}
<div class="card" style="margin-top: 1rem; text-align: center;">
    <p class="status-ok" style="font-size: 1.2rem;">âœ“ Everything looks good!</p>
    <p>No issues detected. Your CV data is in sync.</p>
</div>
{% endif %}
{% endblock %}
