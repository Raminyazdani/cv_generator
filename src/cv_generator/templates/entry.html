{% extends "base.html" %}

{% block title %}Edit Entry Tags{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &raquo;
    <a href="{{ url_for('person_dashboard', person=entry.person_slug) }}">{{ entry.person_slug }}</a> &raquo;
    <a href="{{ url_for('section_entries', person=entry.person_slug, section=entry.section) }}">{{ entry.section | replace('_', ' ') | title }}</a> &raquo;
    Entry
</nav>

<h2>{{ entry.summary }}</h2>

{% if entry.section in ['basics', 'projects', 'experiences', 'publications', 'references', 'education', 'languages', 'profiles', 'workshop_and_certifications'] %}
<div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
    <a href="{{ url_for('edit_entry_route', entry_id=entry.id) }}" class="btn btn-primary">âœï¸ Edit Entry</a>
    <a href="{{ url_for('entry_linked_route', entry_id=entry.id) }}" class="btn btn-secondary">ğŸŒ View Linked Languages</a>
    <a href="{{ url_for('cross_language_editor_route', entry_id=entry.id) }}" class="btn btn-success">ğŸŒ Cross-Language Editor</a>
</div>
{% endif %}

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Assign Tags</h3>
        <div class="language-indicator">
            <span style="color: var(--gray-500); font-size: 0.85rem;">Entry Language: </span>
            <span class="btn btn-sm btn-primary" style="pointer-events: none;">
                {{ entry_language | upper }}
            </span>
            <span style="color: var(--gray-400); font-size: 0.75rem; margin-left: 0.5rem;">
                (Tags shown in this language)
            </span>
        </div>
    </div>
    
    <form action="{{ url_for('update_entry_tags_route', entry_id=entry.id) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <div class="checkbox-list">
                {% if all_tags %}
                    {% for tag in all_tags %}
                    <label class="checkbox-item">
                        <input type="checkbox" name="tags" value="{{ tag.name }}"
                            {% if tag.name in entry.tags %}checked{% endif %}>
                        {{ tag.display_label }}
                        {% if tag.display_label != tag.name and entry_language != 'en' %}
                        <span style="color: var(--gray-400); font-size: 0.8rem;">({{ tag.name }})</span>
                        {% endif %}
                        {% if not tag.has_translation and entry_language != 'en' %}
                        <span class="tag" style="background: var(--warning); font-size: 0.65rem; margin-left: 0.25rem;">no translation</span>
                        {% endif %}
                        <span class="tag tag-count" style="margin-left: auto;">{{ tag.usage_count }}</span>
                    </label>
                    {% endfor %}
                {% else %}
                    <p style="padding: 1rem; color: var(--gray-500);">
                        No tags exist yet. <a href="{{ url_for('create_tag_route') }}">Create one</a>
                    </p>
                {% endif %}
            </div>
        </div>
        
        <div class="actions">
            <button type="submit" class="btn btn-primary">ğŸ’¾ Save Tags</button>
            <a href="{{ url_for('create_tag_route') }}" class="btn btn-secondary">+ New Tag</a>
        </div>
    </form>
</div>

<div class="card" style="margin-top: 1rem;">
    <h3 style="margin-bottom: 1rem;">Entry Data (Read-Only)</h3>
    <details>
        <summary style="cursor: pointer; color: var(--primary);">Show JSON</summary>
        <pre class="json-preview" style="margin-top: 1rem;">{{ data_json }}</pre>
    </details>
</div>

<div class="card" style="margin-top: 1rem; background: var(--gray-100);">
    <h3 style="margin-bottom: 1rem;">ğŸ”§ Debug Info</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <tr>
            <td style="padding: 0.5rem; font-weight: 500; width: 150px;">Entry ID:</td>
            <td style="padding: 0.5rem;"><code>{{ entry.id }}</code></td>
        </tr>
        <tr>
            <td style="padding: 0.5rem; font-weight: 500;">Stable ID:</td>
            <td style="padding: 0.5rem;">
                {% if entry.stable_id %}
                <code style="background: var(--success-light); color: var(--success); padding: 0.25rem 0.5rem; border-radius: 4px;">âœ“ {{ entry.stable_id }}</code>
                {% else %}
                <span style="color: var(--warning);">âš ï¸ No stable ID assigned</span>
                <div style="margin-top: 0.5rem;">
                    <form action="{{ url_for('assign_stable_id_route', entry_id=entry.id) }}" method="post" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-primary" title="Create a new stable ID for this entry">
                            ğŸ”– Assign Stable ID
                        </button>
                    </form>
                    <a href="{{ url_for('link_entries_route', entry_id=entry.id) }}" class="btn btn-sm btn-secondary" style="margin-left: 0.25rem;" title="Link with entries from other languages">
                        ğŸ”— Link with Other Languages
                    </a>
                </div>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td style="padding: 0.5rem; font-weight: 500;">Identity Key:</td>
            <td style="padding: 0.5rem;">
                {% if entry.identity_key %}
                <code>{{ entry.identity_key }}</code>
                {% else %}
                <span style="color: var(--gray-400);">â€”</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td style="padding: 0.5rem; font-weight: 500;">Section:</td>
            <td style="padding: 0.5rem;"><code>{{ entry.section }}</code></td>
        </tr>
        <tr>
            <td style="padding: 0.5rem; font-weight: 500;">Person:</td>
            <td style="padding: 0.5rem;"><code>{{ entry.person_slug }}</code></td>
        </tr>
    </table>
</div>
{% endblock %}
