{% extends "base.html" %}

{% block title %}{{ action }} Entry - {{ get_section_label(section) }}{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &raquo;
    <a href="{{ url_for('person_dashboard', person=person.slug) }}">{{ person.display_name or person.slug }}</a> &raquo;
    <a href="{{ url_for('section_entries', person=person.slug, section=section) }}">{{ get_section_label(section) }}</a> &raquo;
    {{ action }} Entry
</nav>

<h2>{{ action }} {{ get_section_label(section) }} Entry</h2>

<div class="card">
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {# Dynamic fields based on section type #}
        {% if section == 'projects' %}
        <div class="form-group">
            <label for="field_title">{{ get_field_label('title') }} *{% if show_canonical_keys %} <small style="color: var(--gray-400);">(title)</small>{% endif %}</label>
            <input type="text" id="field_title" name="field_title" 
                   value="{{ entry.data.title if entry else '' }}" required
                   placeholder="Project title">
        </div>
        <div class="form-group">
            <label for="field_description">{{ get_field_label('description') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(description)</small>{% endif %}</label>
            <textarea id="field_description" name="field_description" rows="4"
                      placeholder="Project description">{{ entry.data.description if entry else '' }}</textarea>
        </div>
        <div class="form-group">
            <label for="field_url">{{ get_field_label('url') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(url)</small>{% endif %}</label>
            <input type="url" id="field_url" name="field_url" 
                   value="{{ entry.data.url if entry else '' }}"
                   placeholder="https://github.com/...">
            <small style="color: var(--gray-500);">üîó Shared field - will sync across languages if enabled</small>
        </div>
        
        {% elif section == 'experiences' %}
        <div class="form-group">
            <label for="field_role">{{ get_field_label('role') }} *{% if show_canonical_keys %} <small style="color: var(--gray-400);">(role)</small>{% endif %}</label>
            <input type="text" id="field_role" name="field_role" 
                   value="{{ entry.data.role if entry else '' }}" required
                   placeholder="Job title / Role">
        </div>
        <div class="form-group">
            <label for="field_institution">{{ get_field_label('institution') }} *{% if show_canonical_keys %} <small style="color: var(--gray-400);">(institution)</small>{% endif %}</label>
            <input type="text" id="field_institution" name="field_institution" 
                   value="{{ entry.data.institution if entry else '' }}" required
                   placeholder="Company name">
        </div>
        <div class="form-group">
            <label for="field_duration">{{ get_field_label('duration') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(duration)</small>{% endif %}</label>
            <input type="text" id="field_duration" name="field_duration" 
                   value="{{ entry.data.duration if entry else '' }}"
                   placeholder="2020-01 - present">
        </div>
        <div class="form-group">
            <label for="field_description">{{ get_field_label('description') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(description)</small>{% endif %}</label>
            <textarea id="field_description" name="field_description" rows="4"
                      placeholder="Job responsibilities and achievements">{{ entry.data.description if entry else '' }}</textarea>
        </div>
        
        {% elif section == 'publications' %}
        <div class="form-group">
            <label for="field_title">{{ get_field_label('title') }} *{% if show_canonical_keys %} <small style="color: var(--gray-400);">(title)</small>{% endif %}</label>
            <input type="text" id="field_title" name="field_title" 
                   value="{{ entry.data.title if entry else '' }}" required
                   placeholder="Publication title">
        </div>
        <div class="form-group">
            <label for="field_authors">{{ get_field_label('authors') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(authors)</small>{% endif %}</label>
            <input type="text" id="field_authors" name="field_authors" 
                   value="{{ entry.data.authors if entry else '' }}"
                   placeholder="Author names">
        </div>
        <div class="form-group">
            <label for="field_journal">{{ get_field_label('journal') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(journal)</small>{% endif %}</label>
            <input type="text" id="field_journal" name="field_journal" 
                   value="{{ entry.data.journal if entry else '' }}"
                   placeholder="Publication venue">
        </div>
        <div class="form-group">
            <label for="field_year">{{ get_field_label('year') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(year)</small>{% endif %}</label>
            <input type="text" id="field_year" name="field_year" 
                   value="{{ entry.data.year if entry else '' }}"
                   placeholder="2024">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_doi">{{ get_field_label('doi') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(doi)</small>{% endif %}</label>
            <input type="text" id="field_doi" name="field_doi" 
                   value="{{ entry.data.doi if entry else '' }}"
                   placeholder="10.1000/xyz123">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_status">{{ get_field_label('status') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(status)</small>{% endif %}</label>
            <input type="text" id="field_status" name="field_status" 
                   value="{{ entry.data.status if entry else '' }}"
                   placeholder="Published / In Review / Submitted">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        
        {% elif section == 'references' %}
        <div class="form-group">
            <label for="field_name">{{ get_field_label('name') }} *{% if show_canonical_keys %} <small style="color: var(--gray-400);">(name)</small>{% endif %}</label>
            <input type="text" id="field_name" name="field_name" 
                   value="{{ entry.data.name if entry else '' }}" required
                   placeholder="Reference name">
        </div>
        <div class="form-group">
            <label for="field_institution">{{ get_field_label('institution') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(institution)</small>{% endif %}</label>
            <input type="text" id="field_institution" name="field_institution" 
                   value="{{ entry.data.institution if entry else '' }}"
                   placeholder="Institution / Company">
        </div>
        <div class="form-group">
            <label for="field_email">{{ get_field_label('email') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(email)</small>{% endif %}</label>
            <input type="email" id="field_email" name="field_email" 
                   value="{{ entry.data.email if entry else '' }}"
                   placeholder="email@example.com">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_phone">{{ get_field_label('phone') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(phone)</small>{% endif %}</label>
            <input type="text" id="field_phone" name="field_phone" 
                   value="{{ entry.data.phone if entry else '' }}"
                   placeholder="+49 123 456789">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        
        {% elif section == 'education' %}
        <div class="form-group">
            <label for="field_institution">{{ get_field_label('institution') }} *{% if show_canonical_keys %} <small style="color: var(--gray-400);">(institution)</small>{% endif %}</label>
            <input type="text" id="field_institution" name="field_institution" 
                   value="{{ entry.data.institution if entry else '' }}" required
                   placeholder="University name">
        </div>
        <div class="form-group">
            <label for="field_area">{{ get_field_label('area') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(area)</small>{% endif %}</label>
            <input type="text" id="field_area" name="field_area" 
                   value="{{ entry.data.area if entry else '' }}"
                   placeholder="Computer Science">
        </div>
        <div class="form-group">
            <label for="field_studyType">{{ get_field_label('studyType') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(studyType)</small>{% endif %}</label>
            <input type="text" id="field_studyType" name="field_studyType" 
                   value="{{ entry.data.studyType if entry else '' }}"
                   placeholder="Master's / Bachelor's / PhD">
        </div>
        <div class="form-group">
            <label for="field_location">{{ get_field_label('location') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(location)</small>{% endif %}</label>
            <input type="text" id="field_location" name="field_location" 
                   value="{{ entry.data.location | format_location if entry else '' }}"
                   placeholder="City, Country">
        </div>
        <div class="form-group">
            <label for="field_startDate">{{ get_field_label('startDate') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(startDate)</small>{% endif %}</label>
            <input type="text" id="field_startDate" name="field_startDate" 
                   value="{{ entry.data.startDate if entry else '' }}"
                   placeholder="2020-10-01">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_endDate">{{ get_field_label('endDate') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(endDate)</small>{% endif %}</label>
            <input type="text" id="field_endDate" name="field_endDate" 
                   value="{{ entry.data.endDate if entry else '' }}"
                   placeholder="2024-09-30 or 'present'">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_gpa">{{ get_field_label('gpa') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(gpa)</small>{% endif %}</label>
            <input type="text" id="field_gpa" name="field_gpa" 
                   value="{{ entry.data.gpa if entry else '' }}"
                   placeholder="3.5 / 4.0">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        
        {% elif section == 'basics' %}
        <div class="form-group">
            <label for="field_fname">{{ get_field_label('fname') }} *{% if show_canonical_keys %} <small style="color: var(--gray-400);">(fname)</small>{% endif %}</label>
            <input type="text" id="field_fname" name="field_fname" 
                   value="{{ entry.data.fname if entry else '' }}" required
                   placeholder="First name">
        </div>
        <div class="form-group">
            <label for="field_lname">{{ get_field_label('lname') }} *{% if show_canonical_keys %} <small style="color: var(--gray-400);">(lname)</small>{% endif %}</label>
            <input type="text" id="field_lname" name="field_lname" 
                   value="{{ entry.data.lname if entry else '' }}" required
                   placeholder="Last name">
        </div>
        <div class="form-group">
            <label for="field_headline">{{ get_field_label('headline') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(headline)</small>{% endif %}</label>
            <input type="text" id="field_headline" name="field_headline" 
                   value="{{ entry.data.headline if entry else '' }}"
                   placeholder="Software Engineer, Data Scientist, etc.">
        </div>
        <div class="form-group">
            <label for="field_location">{{ get_field_label('location') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(location)</small>{% endif %}</label>
            <input type="text" id="field_location" name="field_location" 
                   value="{{ entry.data.location | format_location if entry else '' }}"
                   placeholder="City, Country">
        </div>
        <div class="form-group">
            <label for="field_email">{{ get_field_label('email') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(email)</small>{% endif %}</label>
            <input type="email" id="field_email" name="field_email" 
                   value="{{ entry.data.email if entry else '' }}"
                   placeholder="email@example.com">
            <small style="color: var(--gray-500);">üîó Shared field - will sync across languages</small>
        </div>
        <div class="form-group">
            <label for="field_phone">{{ get_field_label('phone') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(phone)</small>{% endif %}</label>
            <input type="text" id="field_phone" name="field_phone" 
                   value="{{ entry.data.phone if entry else '' }}"
                   placeholder="+49 123 456 7890">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_website">{{ get_field_label('website') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(website)</small>{% endif %}</label>
            <input type="url" id="field_website" name="field_website" 
                   value="{{ entry.data.website if entry else '' }}"
                   placeholder="https://example.com">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_linkedin">LinkedIn{% if show_canonical_keys %} <small style="color: var(--gray-400);">(linkedin)</small>{% endif %}</label>
            <input type="url" id="field_linkedin" name="field_linkedin" 
                   value="{{ entry.data.linkedin if entry else '' }}"
                   placeholder="https://linkedin.com/in/...">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_github">GitHub{% if show_canonical_keys %} <small style="color: var(--gray-400);">(github)</small>{% endif %}</label>
            <input type="url" id="field_github" name="field_github" 
                   value="{{ entry.data.github if entry else '' }}"
                   placeholder="https://github.com/...">
            <small style="color: var(--gray-500);">üîó Shared field</small>
        </div>
        <div class="form-group">
            <label for="field_summary">{{ get_field_label('summary') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(summary)</small>{% endif %}</label>
            <textarea id="field_summary" name="field_summary" rows="4"
                      placeholder="A brief professional summary">{{ entry.data.summary if entry else '' }}</textarea>
        </div>
        
        {% else %}
        {# Generic fallback for other sections #}
        <div class="form-group">
            <label for="field_title">{{ get_field_label('title') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(title)</small>{% endif %}</label>
            <input type="text" id="field_title" name="field_title" 
                   value="{{ entry.data.title or entry.data.name if entry else '' }}"
                   placeholder="Entry title">
        </div>
        <div class="form-group">
            <label for="field_description">{{ get_field_label('description') }}{% if show_canonical_keys %} <small style="color: var(--gray-400);">(description)</small>{% endif %}</label>
            <textarea id="field_description" name="field_description" rows="4"
                      placeholder="Description">{{ entry.data.description if entry else '' }}</textarea>
        </div>
        {% endif %}
        
        {# Tags / type_key selection #}
        <div class="form-group" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <label style="margin-bottom: 0;">Tags (type_key)</label>
                {% if entry_language %}
                <span style="color: var(--gray-500); font-size: 0.8rem;">
                    Showing tags in: <strong>{{ entry_language | upper }}</strong>
                </span>
                {% endif %}
            </div>
            <div class="checkbox-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 4px; padding: 0.5rem;">
                {% if all_tags %}
                    {% for tag in all_tags %}
                    <label class="checkbox-item">
                        <input type="checkbox" name="type_key" value="{{ tag.name }}"
                            {% if entry and tag.name in (entry.data.type_key or entry.tags or []) %}checked{% endif %}>
                        {{ tag.display_label }}
                        {% if tag.display_label != tag.name and entry_language != 'en' %}
                        <span style="color: var(--gray-400); font-size: 0.8rem;">({{ tag.name }})</span>
                        {% endif %}
                    </label>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--gray-500);">No tags defined. <a href="{{ url_for('create_tag_route') }}">Create one</a></p>
                {% endif %}
            </div>
        </div>
        
        {# Multi-language sync options #}
        <div class="form-group" style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 4px;">
            <h4 style="margin: 0 0 0.5rem 0;">üåê Multi-Language Sync</h4>
            {% if action == 'Create' %}
            <label class="checkbox-item">
                <input type="checkbox" name="sync_languages" checked>
                Create placeholder entries in other languages (EN/DE/FA)
            </label>
            <p style="font-size: 0.85rem; color: var(--gray-600); margin-top: 0.5rem;">
                When enabled, placeholder entries will be created in all available language variants.
                These can be translated later.
            </p>
            {% else %}
            <label class="checkbox-item">
                <input type="checkbox" name="sync_shared_fields">
                Sync shared fields (URL, dates, DOI, etc.) to other languages
            </label>
            <p style="font-size: 0.85rem; color: var(--gray-600); margin-top: 0.5rem;">
                When enabled, fields marked with üîó will be updated in all language variants.
                Text fields (title, description) will only update in the current language.
            </p>
            {% endif %}
        </div>
        
        {# Show linked entries if editing #}
        {% if action == 'Edit' and linked_entries %}
        <div class="form-group" style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, var(--gray-50), #e8f4ff); border-radius: 8px; border: 1px solid var(--gray-200);">
            <h4 style="margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem;">
                üåç Multilingual Variants
                <span style="font-size: 0.8rem; color: var(--gray-500); font-weight: normal;">
                    ({{ linked_entries|length }} language{{ 's' if linked_entries|length > 1 else '' }})
                </span>
            </h4>
            
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                {% for lang, linked_entry in linked_entries.items() %}
                <a href="{{ url_for('edit_entry_route', entry_id=linked_entry.id) }}" 
                   class="btn btn-sm {% if linked_entry.id == entry.id %}btn-primary{% else %}btn-secondary{% endif %}"
                   style="min-width: 50px; text-align: center;">
                    {{ lang | upper }}
                    {% if linked_entry.needs_translation %}
                    <span title="Needs translation" style="color: var(--warning);">‚ö†Ô∏è</span>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
            
            {% if linked_entries|length > 1 %}
            <div style="padding-top: 0.75rem; border-top: 1px solid var(--gray-200);">
                <a href="{{ url_for('cross_language_editor_route', entry_id=entry.id) }}" 
                   class="btn btn-success" style="width: 100%;">
                    üåê Edit All Languages Side-by-Side
                </a>
                <p style="font-size: 0.8rem; color: var(--gray-600); margin: 0.5rem 0 0 0; text-align: center;">
                    Edit all {{ linked_entries|length }} language versions together on one page
                </p>
            </div>
            {% endif %}
        </div>
        {% elif action == 'Edit' %}
        {# No linked entries found - show info #}
        <div class="form-group" style="margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 4px; border: 1px dashed var(--gray-300);">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--gray-500);">üåç Multilingual Variants</h4>
            <p style="font-size: 0.85rem; color: var(--gray-500); margin: 0;">
                No other language variants detected. To link this entry with other languages, 
                use the <a href="{{ url_for('cross_language_editor_route', entry_id=entry.id) }}">Cross-Language Editor</a>.
            </p>
        </div>
        {% endif %}
        
        <div class="actions" style="margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">üíæ {{ 'Create' if action == 'Create' else 'Save' }} Entry</button>
            <a href="{{ url_for('section_entries', person=person.slug, section=section) }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

{% if action == 'Edit' and entry %}
<div class="card" style="margin-top: 1rem;">
    <h3 style="margin-bottom: 1rem; color: var(--danger);">‚ö†Ô∏è Danger Zone</h3>
    <form action="{{ url_for('delete_entry_route', entry_id=entry.id) }}" method="post"
          onsubmit="return confirm('Are you sure you want to delete this entry? This action cannot be undone.');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label class="checkbox-item">
            <input type="checkbox" name="sync_languages" checked>
            Delete from all languages
        </label>
        <p style="font-size: 0.85rem; color: var(--gray-600); margin: 0.5rem 0;">
            When enabled, this entry will be deleted from all language variants (EN, DE, FA).
        </p>
        <button type="submit" class="btn btn-danger" style="margin-top: 0.5rem;">üóëÔ∏è Delete Entry</button>
    </form>
</div>
{% endif %}
{% endblock %}
