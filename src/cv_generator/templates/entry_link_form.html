{% extends "base.html" %}

{% block title %}Link Entries - {{ entry.section | replace('_', ' ') | title }}{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &raquo;
    <a href="{{ url_for('person_dashboard', person=entry.person_slug) }}">{{ entry.person_slug }}</a> &raquo;
    <a href="{{ url_for('section_entries', person=entry.person_slug, section=entry.section) }}">{{ entry.section | replace('_', ' ') | title }}</a> &raquo;
    <a href="{{ url_for('entry_detail', entry_id=entry.id) }}">Entry</a> &raquo;
    Link Entries
</nav>

<h2>üîó Link Multilingual Entries</h2>
<p style="color: var(--gray-600); margin-bottom: 1rem;">{{ entry.summary }}</p>

<style>
.link-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.link-pane {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
}

.link-pane-header {
    background: var(--primary);
    color: white;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.link-pane-header.en { background: #2563eb; }
.link-pane-header.de { background: #dc2626; }
.link-pane-header.fa { background: #16a34a; }

.link-pane-body {
    padding: 1rem;
    max-height: 400px;
    overflow-y: auto;
}

.entry-option {
    padding: 0.75rem;
    border: 1px solid var(--gray-200);
    border-radius: 4px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.entry-option:hover {
    border-color: var(--primary);
    background: var(--gray-50);
}

.entry-option.selected {
    border-color: var(--primary);
    background: var(--primary-light);
}

.entry-option input[type="radio"] {
    margin-right: 0.5rem;
}

.entry-option .entry-summary {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.entry-option .entry-meta {
    font-size: 0.8rem;
    color: var(--gray-500);
}

.linked-badge {
    background: var(--success);
    color: white;
    font-size: 0.7rem;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
}

.no-entries {
    text-align: center;
    color: var(--gray-500);
    padding: 2rem;
    font-style: italic;
}

.current-entry-info {
    background: var(--gray-100);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}
</style>

<div class="current-entry-info">
    <h4 style="margin: 0 0 0.5rem 0;">Current Entry</h4>
    <p style="margin: 0;">
        <strong>{{ entry.summary }}</strong>
        <span class="entry-meta" style="margin-left: 0.5rem;">
            ({{ entry.person_slug }} - ID: {{ entry.id }})
        </span>
    </p>
    {% if stable_id %}
    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
        Stable ID: <code style="background: var(--success-light); color: var(--success); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ stable_id[:12] }}...</code>
    </p>
    {% else %}
    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--warning);">
        ‚ö†Ô∏è No stable ID assigned. Linking will create a new stable ID for this group.
    </p>
    {% endif %}
</div>

<form method="post" id="link-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="link-grid">
        {% for lang in supported_languages %}
        <div class="link-pane">
            <div class="link-pane-header {{ lang }}">
                <span style="font-weight: bold; font-size: 1.1rem;">{{ lang | upper }}</span>
                {% if lang in linked_entries %}
                <span class="linked-badge">‚úì Already Linked</span>
                {% endif %}
            </div>
            
            <div class="link-pane-body">
                {% if lang in linked_entries %}
                <div class="entry-option selected" style="cursor: default;">
                    <div class="entry-summary">{{ get_entry_summary(linked_entries[lang].section, linked_entries[lang].data) }}</div>
                    <div class="entry-meta">
                        Entry ID: {{ linked_entries[lang].id }}
                        {% if linked_entries[lang].id == entry.id %}
                        <strong>(Current)</strong>
                        {% endif %}
                    </div>
                </div>
                {% elif available_entries.get(lang) %}
                <p style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 0.75rem;">
                    Select an entry to link with this group:
                </p>
                {% for avail_entry in available_entries[lang] %}
                <label class="entry-option">
                    <input type="radio" name="entry_{{ lang }}" value="{{ avail_entry.id }}">
                    <div class="entry-summary">{{ avail_entry.summary }}</div>
                    <div class="entry-meta">
                        Entry ID: {{ avail_entry.id }} | Order: {{ avail_entry.order_idx }}
                        {% if avail_entry.tags %}
                        | Tags: {{ avail_entry.tags | join(', ') }}
                        {% endif %}
                    </div>
                </label>
                {% endfor %}
                {% else %}
                <div class="no-entries">
                    No unlinked entries available in {{ lang | upper }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="card" style="margin-top: 1rem;">
        <h4 style="margin-bottom: 0.75rem;">‚ÑπÔ∏è About Linking Entries</h4>
        <ul style="color: var(--gray-600); line-height: 1.8; margin-bottom: 1rem;">
            <li>Linking connects entries from different languages together.</li>
            <li>Linked entries share the same <strong>stable ID</strong> and are treated as translations of each other.</li>
            <li>When you edit shared fields (URL, dates, etc.) with sync enabled, changes propagate to all linked entries.</li>
            <li>Deleting with sync enabled removes all linked entries.</li>
        </ul>
        
        <div class="actions">
            <button type="submit" class="btn btn-primary">üîó Link Selected Entries</button>
            <a href="{{ url_for('entry_linked_route', entry_id=entry.id) }}" class="btn btn-secondary">Cancel</a>
        </div>
    </div>
</form>

<script>
// Highlight selected entries
document.querySelectorAll('.entry-option input[type="radio"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        // Remove selection from siblings
        const pane = this.closest('.link-pane-body');
        pane.querySelectorAll('.entry-option').forEach(function(opt) {
            opt.classList.remove('selected');
        });
        // Add selection to this one
        this.closest('.entry-option').classList.add('selected');
    });
});
</script>
{% endblock %}
