{% extends "base.html" %}

{% block title %}Tags{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &rsaquo; Tags
</div>

<h2>üè∑Ô∏è Tags</h2>

<div class="card" style="margin-bottom: 1rem;">
    <h3>Create a Tag</h3>
    <p class="entry-meta" style="margin-bottom: 1rem;">
        Create a new tag using the current UI language (<strong>{{ current_language|upper }}</strong>).
        This will also create an alias in the same language.
    </p>
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="create_tag">
        <div class="form-group">
            <label for="label">Tag label</label>
            <input type="text" name="label" id="label" placeholder="e.g., Full CV / ÿ±ÿ≤ŸàŸÖŸá ⁄©ÿßŸÖŸÑ / Academic">
        </div>
        <button type="submit" class="btn btn-success">‚ûï Create</button>
    </form>
</div>

{% if tags|length > 1 %}
<div class="card" style="margin-bottom: 1rem;">
    <h3>üîó Merge / Link Tags</h3>
    <p class="entry-meta" style="margin-bottom: 1rem;">
        Link translation-equivalent tags across languages. Select a target tag and one or more source tags to merge.
        All entity associations, translations, and aliases from source tags will be transferred to the target tag.
        Source tags will be deleted after merging.
    </p>
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="merge_tags">
        <div class="form-group" style="margin-bottom: 1rem;">
            <label for="target_tag_id"><strong>Target Tag</strong> (keep this tag)</label>
            <select name="target_tag_id" id="target_tag_id" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                {% for t in tags %}
                    <option value="{{ t.id }}">{{ t.slug }} (ID {{ t.id }}) ‚Äî {% for lang, label in t.translations.items() %}{{ lang|upper }}: {{ label }}{% if not loop.last %}, {% endif %}{% endfor %}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 1rem;">
            <label for="source_tag_ids"><strong>Source Tags</strong> (merge into target, then delete)</label>
            <p class="entry-meta" style="margin-bottom: 0.5rem;">Hold Ctrl/Cmd to select multiple tags.</p>
            <select name="source_tag_ids" id="source_tag_ids" multiple size="5" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                {% for t in tags %}
                    <option value="{{ t.id }}">{{ t.slug }} (ID {{ t.id }}) ‚Äî {% for lang, label in t.translations.items() %}{{ lang|upper }}: {{ label }}{% if not loop.last %}, {% endif %}{% endfor %}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">üîó Merge Tags</button>
    </form>
</div>
{% endif %}

{% if tags %}
<div class="card">
    <h3>All Tags</h3>
    <p class="entry-meta" style="margin-bottom: 1rem;">
        Manage translations and aliases. Export uses tag translations in the selected export language.
    </p>

    <div class="list-item-container">
        {% for t in tags %}
        <div class="list-item" style="align-items: flex-start;">
            <div style="flex: 1;">
                <div style="display:flex; align-items:center; gap: 0.5rem; flex-wrap: wrap;">
                    <strong>{{ t.slug }}</strong>
                    <span class="tag tag-count">ID {{ t.id }}</span>
                    <span class="tag tag-count">Used {{ t.usage_count }}√ó</span>
                </div>

                <div style="margin-top: 0.5rem;">
                    <strong style="font-size: 0.85rem; color: var(--gray-700);">Translations</strong>
                    <div style="margin-top: 0.25rem;">
                        {% for lang in supported_languages %}
                            {% set label = t.translations.get(lang) %}
                            {% if label %}
                                <span class="tag" style="background: var(--primary);">{{ lang|upper }}: {{ label }}</span>
                            {% else %}
                                <span class="tag tag-count">{{ lang|upper }}: ‚Äî</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div style="margin-top: 0.75rem;">
                    <strong style="font-size: 0.85rem; color: var(--gray-700);">Add / Update Translation</strong>
                    <form method="post" style="margin-top: 0.5rem; display:flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="add_translation">
                        <input type="hidden" name="tag_id" value="{{ t.id }}">
                        <select name="tr_lang" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            {% for lang in supported_languages %}
                                <option value="{{ lang }}">{{ lang|upper }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" name="tr_label" placeholder="Translation label..." style="flex:1; min-width: 220px;">
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                    </form>
                </div>

                <div style="margin-top: 0.75rem;">
                    <strong style="font-size: 0.85rem; color: var(--gray-700);">Aliases</strong>
                    <div class="entry-meta" style="margin-top: 0.25rem;">
                        {% for lang in supported_languages %}
                            <span class="tag tag-count">{{ lang|upper }}</span>
                            {% set als = t.aliases.get(lang, []) %}
                            {% if als %}
                                {% for a in als %}
                                    <span class="tag">{{ a }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="entry-meta">‚Äî</span>
                            {% endif %}
                            <br>
                        {% endfor %}
                    </div>

                    <form method="post" style="margin-top: 0.5rem; display:flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="add_alias">
                        <input type="hidden" name="tag_id" value="{{ t.id }}">
                        <select name="al_lang" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            {% for lang in supported_languages %}
                                <option value="{{ lang }}">{{ lang|upper }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" name="al_label" placeholder="Alias label..." style="flex:1; min-width: 220px;">
                        <button type="submit" class="btn btn-sm btn-secondary">Add Alias</button>
                    </form>
                </div>

                <div style="margin-top: 0.75rem;">
                    <form method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this tag? This will remove all associations with CV entries.');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="delete_tag">
                        <input type="hidden" name="tag_id" value="{{ t.id }}">
                        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è Delete Tag</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="card empty-state">
    <p>No tags yet.</p>
    <p style="margin-top: 0.5rem;">Import a CV file (type_key) or create tags above.</p>
</div>
{% endif %}
{% endblock %}
