{% extends "base.html" %}

{% block title %}Conflicts: {{ resume_key }}{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &raquo; 
    <a href="{{ url_for('variant_status_route', resume_key=resume_key) }}">{{ resume_key }}</a> &raquo;
    Conflicts
</div>

<h2>⚠️ Conflict Resolution: {{ resume_key }}</h2>

{% if conflicts %}
<div class="card">
    <h3>Detected Conflicts</h3>
    <p>The following invariant fields have different values across language variants:</p>
    
    <table style="width: 100%; margin-top: 1rem;">
        <thead>
            <tr>
                <th>Entity</th>
                <th>Field</th>
                <th>Values by Language</th>
                <th>Resolution</th>
            </tr>
        </thead>
        <tbody>
        {% for conflict in conflicts %}
            <tr>
                <td>{{ conflict.entity_type }} #{{ conflict.entity_id }}</td>
                <td><strong>{{ conflict.field_name }}</strong></td>
                <td>
                    {% for lang, val in conflict.values_by_lang.items() %}
                        <div style="margin-bottom: 0.5rem;">
                            <span class="tag">{{ lang|upper }}</span>
                            <code>{{ val if val is not none else '(empty)' }}</code>
                        </div>
                    {% endfor %}
                </td>
                <td>
                    <form method="post" action="{{ url_for('resolve_conflict_route', resume_key=resume_key) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="entity_type" value="{{ conflict.entity_type }}">
                        <input type="hidden" name="entity_id" value="{{ conflict.entity_id }}">
                        <input type="hidden" name="field_name" value="{{ conflict.field_name }}">
                        
                        <div class="form-group" style="margin-bottom: 0.5rem;">
                            <select name="resolution" class="btn btn-secondary btn-sm" style="width: 100%;">
                                {% for lang in supported_languages %}
                                    {% if lang in conflict.values_by_lang %}
                                        <option value="use_{{ lang }}">Use {{ lang|upper }} value</option>
                                    {% endif %}
                                {% endfor %}
                                <option value="use_custom">Use custom value</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0.5rem;">
                            <input type="text" name="custom_value" placeholder="Custom value (optional)" 
                                   class="btn btn-secondary btn-sm" style="width: 100%;">
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <h3>✅ No Conflicts!</h3>
        <p>All invariant fields are synchronized across language variants.</p>
    </div>
</div>
{% endif %}

<!-- Variant Status Summary -->
<div class="card">
    <h3>Variant Status</h3>
    <div class="card-grid">
        <div>
            <strong>Existing Languages:</strong>
            {% for lang in status.existing_langs %}
                <span class="tag">{{ lang|upper }}</span>
            {% endfor %}
        </div>
        <div>
            <strong>Missing Languages:</strong>
            {% if status.missing_langs %}
                {% for lang in status.missing_langs %}
                    <span class="tag tag-count">{{ lang|upper }}</span>
                {% endfor %}
            {% else %}
                <span class="status-ok">All languages present</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="actions" style="margin-top: 2rem;">
    <a href="{{ url_for('variant_status_route', resume_key=resume_key) }}" class="btn btn-secondary">← Back to Variant Status</a>
</div>

{% endblock %}
