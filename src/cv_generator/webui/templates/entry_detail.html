{% extends "base.html" %}

{% block title %}Entry - {{ entry.section | replace('_', ' ') | title }}{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &raquo;
    <a href="{{ url_for('person_dashboard', person=person.slug) }}">{{ person.display_name or person.slug }}</a> &raquo;
    <a href="{{ url_for('section_entries', person=person.slug, section=entry.section) }}">{{ get_section_label(entry.section) }}</a> &raquo;
    Entry
</nav>

<h2>ğŸ§© Entry</h2>
<p class="entry-meta" style="margin-bottom: 1rem;">
    <strong>{{ entry.summary }}</strong>
    â€¢ Section: <code>{{ entry.section }}</code>
    â€¢ Lang: <span class="tag tag-count">{{ entry.lang_code|upper }}</span>
    â€¢ Stable ID: <code>{{ entry.stable_id[:8] }}...</code>
</p>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
        <div>
            <h3 style="margin-bottom: 0.25rem;">ğŸ·ï¸ Tags</h3>
            <p class="entry-meta">Tags are shared across languages for the same stable entry.</p>
        </div>
        <div class="actions">
            <a href="{{ url_for('cross_language_editor', entry_id=entry.id) }}" class="btn btn-secondary">ğŸŒ Cross-Language Editor</a>
            <a href="{{ url_for('edit_entry_route', entry_id=entry.id) }}" class="btn btn-primary">ğŸ› ï¸ Edit Raw JSON</a>
        </div>
    </div>

    <div style="margin-top: 0.75rem;">
        {% if tags %}
            {% for t in tags %}
                <form action="{{ url_for('entry_detail', entry_id=entry.id) }}" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="remove_tag">
                    <input type="hidden" name="tag_id" value="{{ t.id }}">
                    <button type="submit" class="tag" title="{{ t.slug }}" style="border: none; cursor: pointer;">
                        {{ t.label }} âœ•
                    </button>
                </form>
            {% endfor %}
        {% else %}
            <span style="color: var(--gray-500); font-style: italic;">No tags yet.</span>
        {% endif %}
    </div>

    <form action="{{ url_for('entry_detail', entry_id=entry.id) }}" method="post" style="margin-top: 1rem;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="add_tag">
        <div class="form-group">
            <label for="tag_input">Add Tag</label>
            <input type="text" name="tag_input" id="tag_input" list="existing_tags" autocomplete="off"
                   placeholder="Type or select a tag (e.g., Full CV / Ø±Ø²ÙˆÙ…Ù‡ Ú©Ø§Ù…Ù„)">
            <datalist id="existing_tags"></datalist>
            <p class="entry-meta" style="margin-top: 0.25rem;">
                Start typing to see existing tags. If the tag doesn't exist, a new one will be created.
            </p>
        </div>
        <button type="submit" class="btn btn-success">â• Add Tag</button>
    </form>
</div>

<div class="card">
    <h3>ğŸ“¦ Entry JSON</h3>
    <p class="entry-meta" style="margin-bottom: 1rem;">This is the stored per-language JSON payload for this entry.</p>
    <pre class="json-preview">{{ json_pretty }}</pre>
</div>

<script>
// Load existing tags for autocomplete
(function() {
    fetch('{{ url_for("api_tags") }}')
        .then(response => response.json())
        .then(tags => {
            const datalist = document.getElementById('existing_tags');
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.label;
                option.setAttribute('data-slug', tag.slug);
                datalist.appendChild(option);
            });
        })
        .catch(err => console.error('Failed to load tags:', err));
})();
</script>
{% endblock %}
