{% extends "base.html" %}

{% block title %}Export CV{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &rsaquo; Export
</div>

<h2>üì§ Export CV JSON Files</h2>

<div class="card-grid">
    <!-- Single Export -->
    <div class="card">
        <h3>Single Export</h3>
        <p class="entry-meta" style="margin-bottom: 1rem;">
            Export a single CV variant to a JSON file.
        </p>

        <form action="{{ url_for('export_single') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-group">
                <label for="person">Person</label>
                <select name="person" id="person" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                    <option value="">-- Select a person --</option>
                    {% for person in persons %}
                        <option value="{{ person.slug }}">{{ person.display_name or person.slug }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="language">Language</label>
                <select name="language" id="language" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                    {% for lang in supported_languages %}
                        <option value="{{ lang }}" {% if lang == current_language %}selected{% endif %}>{{ lang | upper }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="actions" style="margin-top: 1rem;">
                <button type="submit" class="btn btn-success">üì§ Export</button>
                <button type="submit" formaction="{{ url_for('export_preview_v2') }}" class="btn btn-secondary">üëÅÔ∏è Preview</button>
            </div>
        </form>
    </div>

    <!-- Batch Export -->
    <div class="card">
        <h3>Batch Export</h3>
        <p class="entry-meta" style="margin-bottom: 1rem;">
            Export all language variants for selected persons.
        </p>

        <form action="{{ url_for('export_batch') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-group">
                <label>Select Persons</label>
                <div class="checkbox-list" style="max-height: 200px;">
                    {% for person in persons %}
                    <label class="checkbox-item" style="cursor: pointer;">
                        <input type="checkbox" name="persons" value="{{ person.slug }}">
                        <span>{{ person.display_name or person.slug }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="actions" style="margin-top: 1rem;">
                <button type="submit" class="btn btn-success">üì¶ Export All Variants</button>
            </div>
        </form>
    </div>
</div>

<!-- Export by Tags -->
{% if all_tags %}
<div class="card" style="margin-top: 1rem;">
    <h3>üè∑Ô∏è Export by Tags</h3>
    <p class="entry-meta" style="margin-bottom: 1rem;">
        Export entries filtered by selected tags. Only entries containing <strong>all selected tags</strong> will be included.
        The exported entries will only show the selected tags in their <code>type_key</code> field.
    </p>

    <form id="export-by-tags-form" action="{{ url_for('export_by_tags') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="form-group">
            <label for="tag_person">Person</label>
            <select name="person" id="tag_person" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="updateEntryCount()">
                <option value="">-- Select a person --</option>
                {% for person in persons %}
                    <option value="{{ person.slug }}">{{ person.display_name or person.slug }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="tag_language">Language</label>
            <select name="language" id="tag_language" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="updateEntryCount()">
                {% for lang in supported_languages %}
                    <option value="{{ lang }}" {% if lang == current_language %}selected{% endif %}>{{ lang | upper }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Select Tags (entries must have ALL selected tags)</label>
            <div class="checkbox-list" style="max-height: 200px;">
                {% for tag in all_tags %}
                <div class="checkbox-item" style="cursor: pointer;">
                    <input type="checkbox" name="tag_ids" value="{{ tag.id }}" id="tag_{{ tag.id }}" onchange="updateEntryCount()">
                    <label for="tag_{{ tag.id }}">{{ tag.label }} <span class="entry-meta">({{ tag.slug }})</span></label>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label for="custom_filename">Custom Filename (optional)</label>
            <input type="text" name="custom_filename" id="custom_filename" 
                   placeholder="e.g., bio_academic_export.json" 
                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
            <span class="entry-meta">Leave blank for auto-generated filename with timestamp.</span>
        </div>

        <div id="entry-count-display" style="margin: 1rem 0; padding: 0.75rem; background: var(--gray-100); border-radius: 6px; display: none;">
            <strong>Matching entries:</strong> <span id="entry-count">0</span>
        </div>

        <div class="actions" style="margin-top: 1rem;">
            <button type="submit" class="btn btn-success">üè∑Ô∏è Export by Tags</button>
            <button type="submit" formaction="{{ url_for('export_by_tags_preview') }}" class="btn btn-secondary">üëÅÔ∏è Preview</button>
        </div>
    </form>
</div>

<script>
function updateEntryCount() {
    const form = document.getElementById('export-by-tags-form');
    const person = document.getElementById('tag_person').value;
    const language = document.getElementById('tag_language').value;
    const tagCheckboxes = document.querySelectorAll('input[name="tag_ids"]:checked');
    const countDisplay = document.getElementById('entry-count-display');
    const countSpan = document.getElementById('entry-count');
    
    if (!person || tagCheckboxes.length === 0) {
        countDisplay.style.display = 'none';
        return;
    }
    
    const formData = new FormData();
    formData.append('person', person);
    formData.append('language', language);
    tagCheckboxes.forEach(cb => formData.append('tag_ids', cb.value));
    
    fetch('{{ url_for("export_by_tags_count") }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        countSpan.textContent = data.count;
        countDisplay.style.display = 'block';
        if (data.count === 0) {
            countDisplay.style.background = 'var(--danger-50)';
            countDisplay.style.color = 'var(--danger-700)';
        } else {
            countDisplay.style.background = 'var(--gray-100)';
            countDisplay.style.color = 'inherit';
        }
    })
    .catch(err => {
        console.error('Error fetching entry count:', err);
    });
}
</script>
{% endif %}

{% if available_variants %}
<div class="card" style="margin-top: 1rem;">
    <h3>Available Variants (v2 Database)</h3>
    <p class="entry-meta" style="margin-bottom: 1rem;">
        These CV variants are available for export from the v2 database schema.
    </p>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--gray-200);">
                <th style="text-align: left; padding: 0.75rem;">Resume Key</th>
                <th style="text-align: left; padding: 0.75rem;">Language</th>
                <th style="text-align: right; padding: 0.75rem;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for resume_key, lang_code in available_variants %}
            <tr style="border-bottom: 1px solid var(--gray-200);">
                <td style="padding: 0.75rem;">
                    <strong>{{ resume_key }}</strong>
                </td>
                <td style="padding: 0.75rem;">
                    <span class="tag tag-count">{{ lang_code | upper }}</span>
                </td>
                <td style="padding: 0.75rem; text-align: right;">
                    <form action="{{ url_for('export_preview_v2') }}" method="post" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="person" value="{{ resume_key }}">
                        <input type="hidden" name="language" value="{{ lang_code }}">
                        <button type="submit" class="btn btn-sm btn-secondary">üëÅÔ∏è Preview</button>
                    </form>
                    <form action="{{ url_for('export_single') }}" method="post" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="person" value="{{ resume_key }}">
                        <input type="hidden" name="language" value="{{ lang_code }}">
                        <button type="submit" class="btn btn-sm btn-success">üì§ Export</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if export_history %}
<div class="card" style="margin-top: 1rem;">
    <h3>Recent Export History</h3>
    <div class="list-item-container">
        {% for entry in export_history %}
        <div class="list-item">
            <div>
                {% if entry.batch %}
                    <strong>Batch Export ({{ entry.persons_count }} person(s))</strong>
                    <span class="entry-meta" style="display: block; margin-top: 0.25rem;">
                        {{ entry.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} UTC
                        ‚Ä¢
                        {% if entry.failed_count == 0 %}
                            <span class="status-ok">{{ entry.success_count }} exported</span>
                        {% else %}
                            <span class="status-warning">{{ entry.success_count }} succeeded, {{ entry.failed_count }} failed</span>
                        {% endif %}
                    </span>
                    <span class="entry-meta">Output: {{ entry.output_dir }}</span>
                {% else %}
                    <strong>{{ entry.resume_key }}</strong>
                    <span class="tag tag-count">{{ entry.language | upper }}</span>
                    <span class="entry-meta" style="display: block; margin-top: 0.25rem;">
                        {{ entry.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} UTC
                        {% if entry.success %}
                            ‚Ä¢ <span class="status-ok">Exported</span>
                        {% endif %}
                    </span>
                    <span class="entry-meta">{{ entry.output_path }}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if not persons %}
<div class="card" style="margin-top: 1rem;">
    <div class="empty-state">
        <p>No persons found in database.</p>
        <p style="margin-top: 1rem;">
            <a href="{{ url_for('import_page') }}" class="btn btn-primary">üì• Import CV Data</a>
        </p>
    </div>
</div>
{% endif %}

<div class="card" style="margin-top: 1rem; background: var(--gray-50);">
    <h3>‚ÑπÔ∏è Export Information</h3>
    <ul style="margin-left: 1.5rem; color: var(--gray-700);">
        <li>Exported files are saved to the <code>output/json/</code> directory.</li>
        <li>Filenames include timestamps to prevent overwriting previous exports.</li>
        <li>Tags are exported in the selected language using the vocabulary translations.</li>
        <li>The v2 exporter preserves the original JSON structure for LaTeX compatibility.</li>
    </ul>
</div>
{% endblock %}
