<BLOCK> if references|length > 1 </BLOCK>

%-------------------------------------------------------------------------------
%  SECTION TITLE
%-------------------------------------------------------------------------------
\cvsection{References}

%-------------------------------------------------------------------------------
%  CONTENT
%-------------------------------------------------------------------------------
\begin{cventries}
<BLOCK> for r in references </BLOCK>
  % --- Precompute strings safely
  <BLOCK> set contact_emails = (r.get('email') or []) </BLOCK>
  <BLOCK> set raw_phones = (r.get('phone') or []) </BLOCK>
  <BLOCK> set phone_texts = [] </BLOCK>
  <BLOCK> for ph in raw_phones </BLOCK>
    <BLOCK> if ph.get('formatted') </BLOCK>
      <BLOCK> set _ = phone_texts.append(ph.get('formatted')) </BLOCK>
    <BLOCK> elif ph.get('countryCode') and ph.get('number') </BLOCK>
      <BLOCK> set _ = phone_texts.append(ph.get('countryCode') ~ ' ' ~ ph.get('number')) </BLOCK>
    <BLOCK> endif </BLOCK>
  <BLOCK> endfor </BLOCK>
  <BLOCK> set orgline = [r.get('institution'), r.get('location')]
                         | reject('equalto', None)
                         | reject('equalto','')
                         | join(', ') </BLOCK>
  <BLOCK> set posline = r.get('position') or '' </BLOCK>
  <BLOCK> if r.get('department') </BLOCK>
    <BLOCK> set posline = (posline ~ (' — ' if posline else '') ~ r.get('department')) </BLOCK>
  <BLOCK> endif </BLOCK>
  % --- Decide if we have any items to list
  <BLOCK> set has_items = (contact_emails|length > 0) or (phone_texts|length > 0) or (r.get('URL') is not none) </BLOCK>
  \cventry
    {\textbf{<VAR> r.get('name') | latex_escape </VAR>}} % headline
    {<VAR> posline | latex_escape </VAR>}                 % role/department
    {<VAR> orgline | latex_escape </VAR>}                 % institution, location
    {}                                                    % dates (unused)
    <BLOCK> if has_items </BLOCK>
    {%
      \begin{cvitems}
        <BLOCK> if contact_emails </BLOCK>
          \item {\textbf{Email:} <VAR> contact_emails | map('latex_escape') | join(' \enskip•\enskip ') </VAR>}
        <BLOCK> endif </BLOCK>
        <BLOCK> if phone_texts </BLOCK>
          \item {\textbf{Phone:} <VAR> phone_texts | map('latex_escape') | join(' \enskip•\enskip ') </VAR>}
        <BLOCK> endif </BLOCK>
        <BLOCK> if r.get('URL') </BLOCK>
          \item {\href{<VAR> r.get('URL') </VAR>}{\honorlocationstyle{[LETTER]}}}
        <BLOCK> endif </BLOCK>
      \end{cvitems}
    }
    <BLOCK> else </BLOCK>
    {} % no bullets -> clean empty 5th arg
    <BLOCK> endif </BLOCK>
<BLOCK> endfor </BLOCK>
\end{cventries}
<BLOCK> endif </BLOCK>
